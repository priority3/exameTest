services:
  postgres:
    image: pgvector/pgvector:pg16
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?err}
      POSTGRES_DB: exametest
    volumes:
      - pg_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    restart: unless-stopped

  api:
    image: ghcr.io/priority3/exametest-api:${IMAGE_TAG:-main}
    build:
      context: .
      target: api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      API_PORT: 4000
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/exametest
      REDIS_URL: redis://redis:6379
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-}
      OPENAI_CHAT_MODEL: ${OPENAI_CHAT_MODEL:-gpt-4.1-mini}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
    depends_on:
      - postgres
      - redis

  worker:
    image: ghcr.io/priority3/exametest-worker:${IMAGE_TAG:-main}
    build:
      context: .
      target: worker
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/exametest
      REDIS_URL: redis://redis:6379
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-}
      OPENAI_CHAT_MODEL: ${OPENAI_CHAT_MODEL:-gpt-4.1-mini}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
    depends_on:
      - postgres
      - redis

  web:
    image: ghcr.io/priority3/exametest-web:${IMAGE_TAG:-main}
    build:
      context: .
      target: web
    restart: unless-stopped
    environment:
      NODE_ENV: production
      # Server Components (Node-side) talk to the internal API service.
      API_BASE_URL: http://api:4000
    depends_on:
      - api

  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    depends_on:
      - web
      - api
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: ${DOMAIN:?err}
    volumes:
      - ./deploy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config

  migrate:
    image: ghcr.io/priority3/exametest-api:${IMAGE_TAG:-main}
    build:
      context: .
      target: api
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/exametest
    depends_on:
      - postgres
    command: ["pnpm", "db:migrate"]
    restart: "no"

volumes:
  pg_data:
  caddy_data:
  caddy_config:

